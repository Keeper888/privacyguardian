#!/usr/bin/env python3
"""
PrivacyGuardian GUI App Launcher

Creates protected launchers for GUI apps like Cursor, Antigravity, etc.
These set the appropriate environment variables to route traffic through the proxy.
"""

import os
import sys
import subprocess
import urllib.request
from pathlib import Path

PROXY_URL = "http://localhost:6660"
FLAG_FILE = Path.home() / ".privacyguardian" / "enabled"
GUARDIAN_DIR = Path(__file__).parent

# GUI apps and their API environment variables
GUI_APPS = {
    'antigravity': {
        'binary': '/usr/bin/antigravity',
        'env_vars': ['ANTHROPIC_BASE_URL', 'OPENAI_BASE_URL', 'GOOGLE_AI_BASE_URL'],
        'desktop': 'antigravity.desktop',
    },
    'cursor': {
        'binary': '/usr/bin/cursor',
        'env_vars': ['ANTHROPIC_BASE_URL', 'OPENAI_BASE_URL', 'GOOGLE_AI_BASE_URL'],
        'desktop': 'cursor.desktop',
    },
    'windsurf': {
        'binary': '/usr/bin/windsurf',
        'env_vars': ['ANTHROPIC_BASE_URL', 'OPENAI_BASE_URL', 'GOOGLE_AI_BASE_URL'],
        'desktop': 'windsurf.desktop',
    },
    'zed': {
        'binary': '/usr/bin/zed',
        'env_vars': ['ANTHROPIC_BASE_URL', 'OPENAI_BASE_URL', 'GOOGLE_AI_BASE_URL'],
        'desktop': 'zed.desktop',
    },
}


def is_protection_enabled():
    """Check if protection flag file exists"""
    return FLAG_FILE.exists()


def is_proxy_running():
    """Check if proxy is alive via health endpoint"""
    try:
        with urllib.request.urlopen(f"{PROXY_URL}/__guardian__/health", timeout=2) as resp:
            return resp.status == 200
    except:
        return False


def start_proxy():
    """Start the proxy via guardian CLI"""
    guardian_script = GUARDIAN_DIR / "guardian"
    if guardian_script.exists():
        subprocess.Popen(
            [str(guardian_script), "enable"],
            start_new_session=True,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
        import time
        for _ in range(10):
            time.sleep(0.5)
            if is_proxy_running():
                return True
    return False


def notify(title, message, icon="dialog-information"):
    """Send desktop notification"""
    try:
        subprocess.run(
            ["notify-send", "-i", icon, title, message],
            capture_output=True, timeout=5
        )
    except:
        pass


def launch_app(app_name, use_proxy=False):
    """Launch a GUI app with optional proxy routing"""
    app_config = GUI_APPS.get(app_name)
    if not app_config:
        print(f"Unknown app: {app_name}")
        sys.exit(1)

    binary = app_config['binary']

    # Check if binary exists
    if not Path(binary).exists():
        # Try common alternative locations
        alternatives = [
            f"/usr/local/bin/{app_name}",
            f"/opt/{app_name}/{app_name}",
            str(Path.home() / ".local" / "bin" / app_name),
        ]
        for alt in alternatives:
            if Path(alt).exists():
                binary = alt
                break
        else:
            print(f"Could not find {app_name} binary")
            sys.exit(1)

    env = os.environ.copy()

    if use_proxy:
        # Set API base URLs (for apps that respect them)
        for env_var in app_config['env_vars']:
            env[env_var] = PROXY_URL

        # Set system proxy variables (for Electron apps)
        env['HTTP_PROXY'] = PROXY_URL
        env['HTTPS_PROXY'] = PROXY_URL
        env['http_proxy'] = PROXY_URL
        env['https_proxy'] = PROXY_URL

        notify("PrivacyGuardian", f"{app_name} launched with protection", "security-high")

    # Launch the app
    args = [binary]
    if use_proxy:
        # Electron apps support --proxy-server flag
        args.append(f'--proxy-server={PROXY_URL}')
    args.extend(sys.argv[2:])

    subprocess.Popen(
        args,
        env=env,
        start_new_session=True,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL
    )


def main():
    if len(sys.argv) < 2:
        print("Usage: gui-launcher <app-name>")
        print(f"Available apps: {', '.join(GUI_APPS.keys())}")
        sys.exit(1)

    app_name = sys.argv[1]

    if app_name not in GUI_APPS:
        print(f"Unknown app: {app_name}")
        print(f"Available: {', '.join(GUI_APPS.keys())}")
        sys.exit(1)

    # Check if protection is enabled
    if not is_protection_enabled():
        launch_app(app_name, use_proxy=False)
        return

    # Protection enabled - ensure proxy is running
    if not is_proxy_running():
        print("Starting PrivacyGuardian proxy...")
        if not start_proxy():
            notify("PrivacyGuardian", "Could not start proxy - launching unprotected", "dialog-warning")
            launch_app(app_name, use_proxy=False)
            return

    launch_app(app_name, use_proxy=True)


if __name__ == "__main__":
    main()
